{% extends "stepsTemplate.njk" %}
{% from "govuk/components/input/macro.njk" import govukInput %}
{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "govuk/components/details/macro.njk" import govukDetails %}
{% from "govuk/components/error-summary/macro.njk" import govukErrorSummary %}

{% block content %}
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds">
      <h1 class="govuk-heading-l">{{ title }}</h1>

      {% if errorSummary %}
        {{ govukErrorSummary(errorSummary) }}
      {% elif lookupError %}
        {{ govukErrorSummary({
          titleText: errorSummaryTitle,
          errorList: [{ text: lookupError.text, href: '#' ~ (lookupError.field or 'lookupPostcode') }]
        }) }}
      {% endif %}

      <!-- ðŸ” Postcode Lookup Form -->
      <form method="post" action="{{ url }}">
        {{ govukInput({
          id: 'lookupPostcode',
          name: 'lookupPostcode',
          label: { text: labels.lookupPostcode },
          classes: 'govuk-!-width-one-half',
          value: lookupPostcode,
          errorMessage: lookupError and { text: lookupError.text }
        }) }}
        {{ govukButton({
          text: buttons.findAddress,
          attributes: {
            type: 'submit',
            name: 'action',
            value: 'find-address'
          }
        }) }}
      </form>

      <!-- ðŸ“ Address Selection Dropdown -->
      {% if addressResults and addressResults.length > 0 %}
        {% set addressCount = addressResults.length %}
        {% if addressCount == 1 %}
          {% set addressCountText = addressFoundSingle | replace("{{count}}", addressCount | string) %}
        {% else %}
          {% set addressCountText = addressFoundPlural | replace("{{count}}", addressCount | string) %}
        {% endif %}

        <div class="govuk-form-group">
          <label class="govuk-label" for="selectedAddress">{{ labels.selectAddress }}</label>
          <select class="govuk-select govuk-!-width-three-quarters" id="selectedAddress">
            <option value="">-- {{ addressCountText }} --</option>
            {% for address in addressResults %}
              <option
                value="{{ loop.index0 }}"
                data-line1="{{ address.addressLine1 }}"
                data-line2="{{ address.addressLine2 }}"
                data-line3="{{ address.addressLine3 }}"
                data-town="{{ address.town }}"
                data-county="{{ address.county }}"
                data-postcode="{{ address.postcode }}"
                {% if selectedAddressIndex|int == loop.index0 %}selected{% endif %}
              >
                {{ address.fullAddress }}
              </option>
            {% endfor %}
          </select>
        </div>
      {% endif %}

      <!-- âœï¸ Manual Address Entry -->
      {% set manualAddressHtml %}
        {{ govukInput({
          id: 'addressLine1',
          name: 'addressLine1',
          label: { text: labels.addressLine1 },
          value: addressLine1,
          classes: 'govuk-!-width-three-quarters',
          attributes: { maxlength: 50 },
          errorMessage: fieldErrors and fieldErrors.addressLine1 and { text: fieldErrors.addressLine1 }
        }) }}

        {{ govukInput({
          id: 'addressLine2',
          name: 'addressLine2',
          label: { text: labels.addressLine2 },
          value: addressLine2,
          classes: 'govuk-!-width-three-quarters',
          attributes: { maxlength: 50 }
        }) }}

        {{ govukInput({
          id: 'addressLine3',
          name: 'addressLine3',
          label: { text: labels.addressLine3 },
          value: addressLine3,
          classes: 'govuk-!-width-three-quarters',
          attributes: { maxlength: 50 }
        }) }}

        {{ govukInput({
          id: 'town',
          name: 'town',
          label: { text: labels.town },
          value: town,
          classes: 'govuk-!-width-three-quarters',
          attributes: { maxlength: 50 },
          errorMessage: fieldErrors and fieldErrors.town and { text: fieldErrors.town }
        }) }}

        {{ govukInput({
          id: 'county',
          name: 'county',
          label: { text: labels.county },
          value: county,
          classes: 'govuk-!-width-three-quarters',
          attributes: { maxlength: 50 }
        }) }}

        {{ govukInput({
          id: 'postcode',
          name: 'postcode',
          label: { text: labels.postcode },
          value: postcode,
          classes: 'govuk-!-width-one-quarter',
          errorMessage: fieldErrors and fieldErrors.postcode and { text: fieldErrors.postcode }
        }) }}
      {% endset %}

      <!-- ðŸ“© Final Submit Form -->
      <form method="post" action="{{ url }}">
        {{ govukDetails({
          summaryText: labels.manualEntryToggle,
          open: errorSummary or (addressLine1 and town and postcode),
          html: manualAddressHtml
        }) }}

        <input type="hidden" name="action" value="submit-form">
          {{ govukButton({ text: buttons.continue, attributes: { type: 'submit' } }) }}
      </form>
    </div>
  </div>
{% endblock %}
