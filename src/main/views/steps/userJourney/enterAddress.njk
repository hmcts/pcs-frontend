{% extends "stepsTemplate.njk" %}
{% from "govuk/components/input/macro.njk" import govukInput %}
{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "govuk/components/back-link/macro.njk" import govukBackLink %}
{% from "govuk/components/details/macro.njk" import govukDetails %}

{% block content %}
 {{ govukBackLink({ text: back, href: backUrl }) }}


  <div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds">
      <h1 class="govuk-heading-l">{{ title }}</h1>

      {% if error %}
        <div class="govuk-error-summary" aria-labelledby="error-summary-title" role="alert" tabindex="-1">
          <h2 class="govuk-error-summary__title" id="error-summary-title">{{ errorSummaryTitle }}</h2>
          <div class="govuk-error-summary__body">
            <ul class="govuk-list govuk-error-summary__list">
              <li>{{ error }}</li>
            </ul>
          </div>
        </div>
      {% endif %}

      <!-- 🔍 Postcode Lookup Form -->
      <form method="post" action="{{ url }}">
        <div class="govuk-form-group">
          <label class="govuk-label" for="lookupPostcode">{{ labels.lookupPostcode }}</label>
          <div class="govuk-grid-row">
            <div class="govuk-grid-column-two-thirds">
              <input class="govuk-input govuk-!-width-one-half" id="lookupPostcode" name="lookupPostcode" value="{{ lookupPostcode }}">
              <button class="govuk-button" name="action" value="find-address" type="submit">
                {{ buttons.findAddress }}
              </button>
            </div>
          </div>
        </div>
      </form>

      <!-- 📍 Address Selection Dropdown -->
      {% if addressResults and addressResults.length > 0 %}
              {% set addressCount = addressResults.length %}
       {% if addressCount == 1 %}
          {% set addressCountText = t['addressFoundSingle'] | replace("{{count}}", addressCount) %}
        {% else %}
          {% set addressCountText = t['addressFoundPlural'] | replace("{{count}}", addressCount) %}
        {% endif %}

  <form method="post" action="{{ url }}">
    <div class="govuk-form-group">
      <label class="govuk-label" for="selectedAddress">{{ labels.selectAddress }}</label>
      <select class="govuk-select govuk-!-width-three-quarters" id="selectedAddress">
        <option value="">-- {{ addressCountText }} --</option>
        {% for address in addressResults %}
          <option
            value="{{ loop.index0 }}"
            data-line1="{{ address.addressLine1 }}"
            data-line2="{{ address.addressLine2 }}"
            data-line3="{{ address.addressLine3 }}"
            data-town="{{ address.town }}"
            data-county="{{ address.county }}"
            data-postcode="{{ address.postcode }}"
            {% if selectedAddressIndex|int == loop.index0 %}selected{% endif %}
          >
            {{ address.fullAddress }}
          </option>
        {% endfor %}
      </select>
    </div>
  </form>
{% endif %}


      <!-- ✍️ Manual Address Entry -->
      {% set manualAddressHtml %}
        {{ govukInput({
          id: 'addressLine1',
          name: 'addressLine1',
          label: { text: labels.addressLine1 },
          value: addressLine1,
          classes: 'govuk-!-width-three-quarters',
          attributes: { maxlength: 50 },
          errorMessage: error_addressLine1 and { text: error_addressLine1 }
        }) }}

        {{ govukInput({
          id: 'addressLine2',
          name: 'addressLine2',
          label: { text: labels.addressLine2 },
          value: addressLine2,
          classes: 'govuk-!-width-three-quarters',
          attributes: { maxlength: 50 }
        }) }}

        {{ govukInput({
          id: 'addressLine3',
          name: 'addressLine3',
          label: { text: labels.addressLine3 },
          value: addressLine3,
          classes: 'govuk-!-width-three-quarters',
          attributes: { maxlength: 50 }
        }) }}

        {{ govukInput({
          id: 'town',
          name: 'town',
          label: { text: labels.town },
          value: town,
          classes: 'govuk-!-width-three-quarters',
          attributes: { maxlength: 50 },
          errorMessage: error_town and { text: error_town }
        }) }}

        {{ govukInput({
          id: 'county',
          name: 'county',
          label: { text: labels.county },
          value: county,
          classes: 'govuk-!-width-three-quarters',
          attributes: { maxlength: 50 }
        }) }}

        {{ govukInput({
          id: 'postcode',
          name: 'postcode',
          label: { text: labels.postcode },
          value: postcode,
          classes: 'govuk-!-width-one-quarter',
          errorMessage: error_postcode and { text: error_postcode }
        }) }}
      {% endset %}

      <!-- 📩 Final Submit Form -->
      <form method="post" action="{{ url }}">
        {{ govukDetails({
          summaryText: labels.manualEntryToggle,
          open: addressLine1 and town and postcode,
          html: manualAddressHtml
        }) }}

        <input type="hidden" name="action" value="submit-form">
          {{ govukButton({ text: buttons.continue }) }}
      </form>
    </div>
  </div>
{% endblock %}
