#!groovy

@Library("Infrastructure")

import uk.gov.hmcts.contino.AppPipelineDsl
import uk.gov.hmcts.contino.GithubAPI

def type = "nodejs"
def product = "pcs"
def component = "frontend"

def yarnBuilder = new uk.gov.hmcts.contino.YarnBuilder(this)

static Map < String, Object > secret(String secretName, String envVariable) {
  [
    $class: 'AzureKeyVaultSecret',
    secretType: 'Secret',
    name: secretName,
    envVariable: envVariable
  ]
}

def secrets = [
  'pcs-${env}': [
    secret('pcs-frontend-idam-secret', 'PCS_FRONTEND_IDAM_SECRET'),
    secret('idam-pcs-user-password', 'IDAM_PCS_USER_PASSWORD')
  ]
]

withPipeline(type, product, component) {
  def githubApi = new GithubAPI(this)
  loadVaultSecrets(secrets)
  env.NODE_CONFIG_ENV = 'test'
  onPR() {
    if (githubApi.getLabelsbyPattern(env.BRANCH_NAME, "enable_error_messages_validation").size() > 0) {
      env.ENABLE_ERROR_MESSAGES_VALIDATION = 'true'
    }
    else {
      env.ENABLE_ERROR_MESSAGES_VALIDATION = 'false'
    }
    env.TEST_URL = "https://pcs-frontend-pr-${CHANGE_ID}.preview.platform.hmcts.net"
    env.DATA_STORE_URL_BASE = "http://ccd-data-store-api-aat.service.core-compute-aat.internal"
    env.PCS_API_URL_PREVIEW = "http://pcs-api-aat.service.core-compute-aat.internal"
    def apiLabels = githubApi.getLabelsbyPattern(env.BRANCH_NAME, "pcs-api-pr:")
    if (apiLabels && apiLabels.size() > 0) {
        def labelName = apiLabels[0]
        env.PCS_API_CHANGE_ID = labelName.replace("pcs-api-pr:", "")
        env.DATA_STORE_URL_BASE = "https://ccd-data-store-api-pcs-api-pr-${env.PCS_API_CHANGE_ID}.preview.platform.hmcts.net"
        env.PCS_API_URL_PREVIEW = "https://pcs-api-pr-${env.PCS_API_CHANGE_ID}.preview.platform.hmcts.net"
    }
    enablePactAs([
      AppPipelineDsl.PactRoles.CONSUMER,
      AppPipelineDsl.PactRoles.CONSUMER_DEPLOY_CHECK
    ])
    afterAlways('functionalTest:preview') {
      archiveFunctionalTestReports()
            if (currentBuild.currentResult in ['FAILURE', 'UNSTABLE']) {
                postAllureResultsToSlack('master')
            }
    }
    afterAlways('fullFunctionalTest:preview') {
      archiveFunctionalTestReports()
    }
  }

  onMaster() {
    env.TEST_URL = "https://pcs.aat.platform.hmcts.net/"
    env.DATA_STORE_URL_BASE="http://ccd-data-store-api-aat.service.core-compute-aat.internal"
    enablePactAs([
      AppPipelineDsl.PactRoles.CONSUMER,
      AppPipelineDsl.PactRoles.CONSUMER_DEPLOY_CHECK
    ])
    afterAlways('functionalTest:aat') {
      archiveFunctionalTestReports()
      if (currentBuild.currentResult in ['FAILURE', 'UNSTABLE']) {
          postAllureResultsToSlack('master')
      }
    }
  }
}

def archiveFunctionalTestReports() {
  try {
    publishHTML([
      allowMissing: true,
      alwaysLinkToLastBuild: true,
      keepAll: true,
      reportDir: "allure-report",
      reportFiles: 'index.html',
      reportName: 'PCS Frontend Functional Test Report'
    ])
  } catch (Error) {
      unstable(message: "${STAGE_NAME} is unstable: " + Error.toString())
  }
}

def postAllureResultsToSlack(String pipelineType = 'master') {
  def msg = sh(
    script: "yarn exec ts-node src/test/ui/scripts/allure-slack-notifier.ts --print-only --pipeline-type ${pipelineType} 2>/dev/null || true",
    returnStdout: true
  ).trim()
  if (!msg) {
    msg = "Functional Test Results — Build #${env.BUILD_NUMBER}\n*Service:* pcs-frontend  |  *Pipeline:* ${pipelineType}\n\nAllure report not available – check build logs.\n*Allure report:* ${env.BUILD_URL}PCS_20Frontend_20Functional_20Test_20Report/"
  }
  try {
    slackSend(channel: '#hdp-qa-e2e-test-results', message: msg)
  } catch (Exception e) {
    echo "WARNING: Allure Slack notification failed: ${e.message}"
  }
}
