#!groovy

@Library("Infrastructure")

import uk.gov.hmcts.contino.AppPipelineDsl

def type = "nodejs"
def product = "pcs"
def component = "frontend"

def yarnBuilder = new uk.gov.hmcts.contino.YarnBuilder(this)

withPipeline(type, product, component) {
  onPR() {
    env.TEST_URL = "https://pcs-frontend-pr-${CHANGE_ID}.preview.platform.hmcts.net"
    enablePactAs([ AppPipelineDsl.PactRoles.CONSUMER ])
    afterAlways('pactTests') {
      try {
        sh 'node -v || echo "Node.js is NOT installed!"'
        sh 'yarn --version || echo "Yarn is NOT installed!"'

        sh 'ls -l node_modules/@pact-foundation/pact || echo "Pact module not found!"'

        sh 'cat package.json | grep pact || echo "Pact script missing in package.json!"'

        sh 'yarn run test:pact:run-and-publish || echo "Pact test script failed!"'

        // Run Pact tests
        yarnBuilder.yarn('test:pact:run-and-publish')

      } catch (Error) {
        unstable(message: "${STAGE_NAME} is unstable: " + Error.toString())
      }
    }
    afterAlways('functionalTest:preview') {
      try {
        publishHTML([
          allowMissing         : true,
          alwaysLinkToLastBuild: true,
          keepAll              : true,
          reportDir            : "playwright-report",
          reportFiles          : 'index.html',
          reportName           : 'PCS Frontend Functional Test Report'
        ])
        steps.archiveArtifacts allowEmptyArchive: true, artifacts: 'reports/tests-results/ManageCasesFunctional/*'
      } catch (Error) {
        unstable(message: "${STAGE_NAME} is unstable: " + Error.toString())
      }
    }
    afterSuccess('functionalTest:preview') {
      stage('Accessibility Test - preview') {
        try {
          yarnBuilder.yarn('test:accessibility')
        } catch (Error) {
          unstable(message: "${STAGE_NAME} is unstable: " + Error.toString())
        } finally {
          publishHTML([
            allowMissing         : true,
            alwaysLinkToLastBuild: true,
            keepAll              : true,
            reportDir            : "playwright-report",
            reportFiles          : 'index.html',
            reportName           : 'Accessibility Test Report'
          ])
          steps.archiveArtifacts allowEmptyArchive: true, artifacts: 'reports/tests-results/ManageCasesFunctional/*'
        }
      }
    }
  }

  onMaster() {
    env.TEST_URL = "https://pcs.aat.platform.hmcts.net/"
    enablePactAs([ AppPipelineDsl.PactRoles.CONSUMER ])
    afterAlways('functionalTest:aat') {
      try {
        publishHTML([
          allowMissing         : true,
          alwaysLinkToLastBuild: true,
          keepAll              : true,
          reportDir            : "playwright-report",
          reportFiles          : 'index.html',
          reportName           : 'PCS Frontend Functional Test Report'
        ])
        steps.archiveArtifacts allowEmptyArchive: true, artifacts: 'reports/tests-results/ManageCasesAccessibility/*'
      } catch (Error) {
        unstable(message: "${STAGE_NAME} is unstable: " + Error.toString())
      }
    }
    afterSuccess('functionalTest:aat') {
      stage('Accessibility Test - aat') {
        try {
          yarnBuilder.yarn('test:accessibility')
        } catch (Error) {
          unstable(message: "${STAGE_NAME} is unstable: " + Error.toString())
        } finally {
          publishHTML([
            allowMissing         : true,
            alwaysLinkToLastBuild: true,
            keepAll              : true,
            reportDir            : "playwright-report",
            reportFiles          : 'index.html',
            reportName           : 'Accessibility Test Report'
          ])
          steps.archiveArtifacts allowEmptyArchive: true, artifacts: 'reports/tests-results/ManageCasesAccessibility/*'
        }
      }
    }
  }
}
